---
import Layout from '../../../../../layouts/Layout.astro';
import Navbar from '../../../../../components/Navbar.astro';
import Footer from '../../../../../components/Footer.astro';
import { discoverManifests, getAllPages, getCategories, formatCategoryTitle } from '../../../../../lib/content-loader';

export function getStaticPaths() {
  const manifests = discoverManifests();
  const allPages = getAllPages();
  const paths: any[] = [];

  for (const { manifest } of manifests) {
    for (const collection of manifest.collections) {
      const categories = getCategories(allPages, manifest.repo.slug, collection.id);
      for (const category of categories) {
        paths.push({
          params: {
            repoSlug: manifest.repo.slug,
            collectionId: collection.id,
            category,
          },
          props: { manifest, collection, category },
        });
      }
    }
  }
  return paths;
}

const { manifest, collection, category } = Astro.props;
const allPages = getAllPages();
const categoryPages = allPages
  .filter(p => p.repoSlug === manifest.repo.slug && p.collectionId === collection.id && p.category === category)
  .sort((a, b) => a.title.localeCompare(b.title));

const categoryTitle = formatCategoryTitle(category);
---

<Layout>
  <Navbar />

  <div class="toolkit-content-page">
    <div class="pt-20 lg:pt-24 pb-16 lg:pb-24 bg-white dark:bg-gray-900">
      <div class="px-4 mx-auto max-w-screen-xl">

        <!-- Breadcrumbs -->
        <nav class="reveal mb-8" aria-label="Breadcrumb">
          <ol class="flex flex-wrap items-center gap-1 text-sm text-gray-500 dark:text-gray-400">
            <li><a href="/toolkit/" class="hover:text-gray-900 dark:hover:text-white transition-colors">Toolkit</a></li>
            <li class="flex items-center">
              <svg class="w-3 h-3 mx-1.5 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <a href={`/toolkit/${manifest.repo.slug}/`} class="hover:text-gray-900 dark:hover:text-white transition-colors">{manifest.repo.title}</a>
            </li>
            <li class="flex items-center">
              <svg class="w-3 h-3 mx-1.5 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <a href={`/toolkit/${manifest.repo.slug}/${collection.id}/`} class="hover:text-gray-900 dark:hover:text-white transition-colors">{collection.title}</a>
            </li>
            <li class="flex items-center">
              <svg class="w-3 h-3 mx-1.5 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="text-gray-900 dark:text-white font-medium">{categoryTitle}</span>
            </li>
          </ol>
        </nav>

        <div class="reveal rd1 mb-10">
          <h1 class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white tracking-tight mb-3">{categoryTitle}</h1>
          <p class="text-lg text-gray-500 dark:text-gray-400">
            {categoryPages.length} {categoryPages.length === 1 ? 'framework' : 'frameworks'} in {categoryTitle.toLowerCase()}
          </p>
        </div>

        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {categoryPages.map((page, idx) => (
            <a href={page.url}
              class={`reveal item-card group p-5 rounded-xl border border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800/60 hover:border-gray-200 dark:hover:border-gray-700 transition-all`}>
              <div class="flex items-start justify-between gap-3 mb-2">
                <h3 class="text-base font-semibold text-gray-900 dark:text-white">{page.title}</h3>
                <svg class="w-3.5 h-3.5 text-gray-300 dark:text-gray-600 group-hover:text-gray-400 dark:group-hover:text-gray-500 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
              {page.frontmatter.one_liner && (
                <p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-3 line-clamp-2">{page.frontmatter.one_liner}</p>
              )}
              {page.frontmatter.source_guest && (
                <div class="flex items-center gap-1.5 text-xs text-gray-400 dark:text-gray-500">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"/>
                  </svg>
                  {page.frontmatter.source_guest}
                </div>
              )}
            </a>
          ))}
        </div>
      </div>
    </div>

    <Footer />
  </div>
</Layout>

<style>
  .toolkit-content-page {
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
  }

  .reveal {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1),
                transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .reveal.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .rd1 { transition-delay: 0.1s; }

  .item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
  }
  .item-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  }
  :global(.dark) .item-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>

<script is:inline>
  (function() {
    var observer = new IntersectionObserver(
      function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) entry.target.classList.add('visible');
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -32px 0px' }
    );
    document.querySelectorAll('.toolkit-content-page .reveal').forEach(function(el) {
      observer.observe(el);
    });
  })();
</script>
