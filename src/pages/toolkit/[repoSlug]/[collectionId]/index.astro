---
import Layout from '../../../../layouts/Layout.astro';
import Navbar from '../../../../components/Navbar.astro';
import Footer from '../../../../components/Footer.astro';
import { discoverManifests, getAllPages, getCategories, formatCategoryTitle } from '../../../../lib/content-loader';

export function getStaticPaths() {
  const manifests = discoverManifests();
  const paths: any[] = [];
  for (const { manifest } of manifests) {
    for (const collection of manifest.collections) {
      paths.push({
        params: {
          repoSlug: manifest.repo.slug,
          collectionId: collection.id,
        },
        props: { manifest, collection },
      });
    }
  }
  return paths;
}

const { manifest, collection } = Astro.props;
const allPages = getAllPages();
const collectionPages = allPages.filter(
  p => p.repoSlug === manifest.repo.slug && p.collectionId === collection.id
);
const categories = getCategories(allPages, manifest.repo.slug, collection.id);
---

<Layout>
  <Navbar />

  <div class="toolkit-content-page">
    <div class="pt-20 lg:pt-24 pb-16 lg:pb-24 bg-white dark:bg-gray-900">
      <div class="px-4 mx-auto max-w-screen-xl">

        <!-- Breadcrumbs -->
        <nav class="reveal mb-8" aria-label="Breadcrumb">
          <ol class="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400">
            <li><a href="/toolkit/" class="hover:text-gray-900 dark:hover:text-white transition-colors">Toolkit</a></li>
            <li class="flex items-center">
              <svg class="w-3 h-3 mx-1.5 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <a href={`/toolkit/${manifest.repo.slug}/`} class="hover:text-gray-900 dark:hover:text-white transition-colors">{manifest.repo.title}</a>
            </li>
            <li class="flex items-center">
              <svg class="w-3 h-3 mx-1.5 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="text-gray-900 dark:text-white font-medium">{collection.title}</span>
            </li>
          </ol>
        </nav>

        <div class="reveal rd1 mb-12">
          <h1 class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white tracking-tight mb-3">{collection.title}</h1>
          <p class="text-lg text-gray-500 dark:text-gray-400 leading-relaxed max-w-2xl mb-2">{collection.description}</p>
          <p class="text-sm text-gray-400 dark:text-gray-500">{collectionPages.length} items{categories.length > 0 ? ` across ${categories.length} categories` : ''}</p>
        </div>

        {categories.length > 0 ? (
          <!-- Grouped by category -->
          <div class="space-y-14">
            {categories.map((category, catIdx) => {
              const categoryPages = collectionPages
                .filter(p => p.category === category)
                .sort((a, b) => a.title.localeCompare(b.title));
              return (
                <section class="reveal">
                  <div class="flex items-center gap-3 mb-5">
                    <a href={`/toolkit/${manifest.repo.slug}/${collection.id}/${category}/`}
                      class="text-xl font-semibold text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                      {formatCategoryTitle(category)}
                    </a>
                    <span class="inline-flex items-center justify-center h-5 min-w-[20px] px-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700/50 rounded-full">{categoryPages.length}</span>
                  </div>
                  <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                    {categoryPages.map(page => (
                      <a href={page.url}
                        class="item-card group p-4 rounded-lg border border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800/60 hover:border-gray-200 dark:hover:border-gray-700 transition-all">
                        <div class="flex items-start justify-between gap-3">
                          <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-1 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors">{page.title}</h3>
                            {page.frontmatter.one_liner && (
                              <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed line-clamp-2">{page.frontmatter.one_liner}</p>
                            )}
                          </div>
                          <svg class="w-3.5 h-3.5 text-gray-300 dark:text-gray-600 group-hover:text-gray-400 dark:group-hover:text-gray-500 transition-colors flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                          </svg>
                        </div>
                      </a>
                    ))}
                  </div>
                </section>
              );
            })}
          </div>
        ) : (
          <!-- Flat list (learning plans) -->
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {collectionPages.sort((a, b) => a.title.localeCompare(b.title)).map((page, idx) => (
              <a href={page.url}
                class={`reveal item-card group p-5 rounded-xl border border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800/60 hover:border-gray-200 dark:hover:border-gray-700 transition-all`}>
                <div class="flex items-start gap-3.5">
                  <div class="flex-shrink-0 flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-700/50 group-hover:bg-gray-200 dark:group-hover:bg-gray-700 transition-colors mt-0.5">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.03v13m0-13c-2.819-.831-4.715-1.076-8.029-1.023A.99.99 0 0 0 3 6v11c0 .563.466 1.014 1.03 1.007 3.122-.043 5.018.212 7.97 1.023m0-13c2.819-.831 4.715-1.076 8.029-1.023A.99.99 0 0 1 21 6v11c0 .563-.466 1.014-1.03 1.007-3.122-.043-5.018.212-7.97 1.023"/>
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1.5">{page.title}</h3>
                    {page.frontmatter.target_audience && (
                      <p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-3 line-clamp-2">{page.frontmatter.target_audience}</p>
                    )}
                    <div class="flex items-center gap-2 text-xs text-gray-400 dark:text-gray-500">
                      {page.frontmatter.difficulty && (
                        <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-gray-400 rounded font-medium">{page.frontmatter.difficulty}</span>
                      )}
                      {page.frontmatter.time_commitment && (
                        <span>{page.frontmatter.time_commitment}</span>
                      )}
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        )}
      </div>
    </div>

    <Footer />
  </div>
</Layout>

<style>
  .toolkit-content-page {
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
  }

  .reveal {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1),
                transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .reveal.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .rd1 { transition-delay: 0.1s; }

  .item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
  }
  .item-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  }
  :global(.dark) .item-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>

<script is:inline>
  (function() {
    var observer = new IntersectionObserver(
      function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) entry.target.classList.add('visible');
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -32px 0px' }
    );
    document.querySelectorAll('.toolkit-content-page .reveal').forEach(function(el) {
      observer.observe(el);
    });
  })();
</script>
